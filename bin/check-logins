#!/usr/bin/perl
use strict;
use warnings;

use Geo::IP;

my %logins;

for (`sudo journalctl --no-pager --grep=accepted`) {
#for (`sudo journalctl --since "08:00" --no-pager --grep=accepted`) {
    # Apr 25 15:00:03 alarm sshd[28112]: Accepted publickey for reisinge from 213.81.128.189 port 34068 ssh2: RSA SHA256:G26bg1d3QonXTl8nmkPzTGCC96Xu4rJx6cYxNNn74vw
    my ( $Mon, $day, $time ) = (split)[ 0, 1, 2 ];
    if (/(\w+)\s+from\s+([\d\.]+)/) {
        my ( $user, $ipaddr ) = ( $1, $2 );
        $logins{$user}{$ipaddr}++;
        printf "%s %d %s %10s %s\n", $Mon, $day, $time, $user, $ipaddr;
    }
}

print "-" x 45, "\n";

my $gi = Geo::IP->new(GEOIP_MEMORY_CACHE);

for my $user (sort keys %logins) {
    print "$user\n";
    for my $ip (sort { $logins{$user}{$b} <=> $logins{$user}{$a} } keys %{$logins{$user}}) {
        my $country = $gi->country_name_by_addr($ip) // 'unknown';
        print "  $ip ($country): $logins{$user}{$ip}\n";
    }
}

#!/bin/bash

function usage_and_exit {
    echo "Setup proxy; ex. when in a corporate environment :-)"
    echo
    echo "Usage: source $0"
    exit
}

# Make sure we are sourced not run
[[ $_ != $0 ]] || usage_and_exit

# Try to find out the proxy
wget -q http://wpad/wpad.dat -O /tmp/wpad.dat
PROXY=$(perl -wne '/PROXY\s* ([\d\.]+:\d{1,4})/ && print $1' /tmp/wpad.dat)

# Didn't find out the proxy
if [ -z "$PROXY" ]; then
    echo -n "Enter PROXY:PORT> "
    read PROXY
fi

echo -n "Enter password for $USER> "
stty_orig=`stty -g` # save original terminal setting
stty -echo          # turn-off echoing
read PASSWD         # read the password
stty $stty_orig     # restore terminal setting
echo

# For general use
export http_proxy="http://$USER:$PASSWD@$PROXY"
export https_proxy="http://$USER:$PASSWD@$PROXY"

# For Vagrant
export VAGRANT_HTTP_PROXY="http://$USER:$PASSWD@$PROXY"
export VAGRANT_HTTPS_PROXY="http://$USER:$PASSWD@$PROXY"
